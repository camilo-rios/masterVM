#!/bin/bash
# 
clear
echo
printf '\e[1;34m%-6s\e[m\n' "This script will configure the interfaces for this box and the also the OBM client files. "
printf '\e[1;34m%-6s\e[m\n' "It is assumed the first network interface (ens192) is the connection to FBB and second adapter (ens224) is the connection to the internal lan."
echo
finalConfirmation='n'
while [ $finalConfirmation = 'n' ]
do
echo
printf '\e[1;34m%-6s\e[m'  "Please confirm FBB interface IP is 192.168.0.5 (default) (y/n)?  "
read confirmation
if [[ $confirmation == 'y' ]]
 then
 	#echo Confirmation: $confirmation
	ipAddress='192.168.0.5/24'
	gwAddress='192.168.0.1'
 else
	correctIP='n'
	while [ $correctIP == 'n' ]
	do
		printf '\e[1;34m%-6s\e[m'  "Please enter FBB IP address - interface ens192(A.B.C.D/Z format) : "
		read ipAddress
		if [[ "$ipAddress" != *"/"* ]]
		then
			printf '\e[1;31m%-6s\e[m\n' "It seems you didn't specify the subnet. Format needs to be A.B.C.D/Z. Please try again: "
		else
			correctIP='y'
		fi
	done
	 printf '\e[1;34m%-6s\e[m' "Please enter FBB default gateway IP : "
	 read gwAddress
 fi

###### This section gets the IP for the secondary interface and makes sure it is entered properly
correctIP='n'
while [ $correctIP == 'n' ]
	do
		printf '\e[1;34m%-6s\e[m' "Please enter native vlan IP for secondary interface (A.B.C.D/Z format) : "
		read nativeIpAddress 
		if [[ "$nativeIpAddress" != *"/"* ]]
		then
			printf '\e[1;31m%-6s\e[m\n' "It seems you didn't specify the subnet. Format needs to be A.B.C.D/Z. Please try again "
			#printf '\e[1;34m%-6s\e[m' "Enter native vlan IP for secondary interface (A.B.C.D/Z format) : "
			#read nativeIpAddress
		else
			correctIP='y'
		fi
	done

######### This section gets the port to use for the OBM tunnel. It is built using the second octet and the last two digits of the subnet network 
while IFS=  read -r line
do
	if [[ "$line" == *"Network address"* ]];
	then 
		#echo $line
		A="$(cut -d'.' -f2 <<<"$line")"
		B="$(cut -d'.' -f4 <<<"$line")"
		if [ $B -eq 0 ]
		then 
			port=$A'00'
			#echo "port: " $port
		else
			port=$A${B: -2}
		fi
	fi
done < <(sipcalc  $nativeIpAddress)

##########
echo
printf '\e[1;34m%-6s\e[m' "Enter the username for VPN authentication. ThreeLetterCustomer_VesselName (ex. NAK_Al_Gharrafa) : "
read username
#echo "port: " $port
echo 
printf '\e[1;34m%-6s\e[m\n' "Please review the info and confirm it is correct"
echo "FBB interface (ens192) IP : "$ipAddress
echo "FBB GW IP :  "$gwAddress 
echo "Native vlan interface (ens224) IP  : "$nativeIpAddress
echo "Username for VPN authentication : "$username
printf "Port number for VPN connection (this is the port to be configured in the OBM GUI): "$port
echo
echo
printf '\e[1;34m%-6s\e[m' "Confirm (y/n)? "
read finalConfirmation
done
echo
printf '\e[1;34m%-6s\e[m\n' "Preparing configuration files"
sed -i  "s~A.A.A.A~$ipAddress~g" /home/mtn/sampleFiles/interfaces
sed -i  "s~GA.GA.GA.GA~$gwAddress~g" /home/mtn/sampleFiles/interfaces
sed -i -e "s~B.B.B.B~$nativeIpAddress~g" /home/mtn/sampleFiles/interfaces
sed -i -e "s~portNumber~$port~g" /home/mtn/sampleFiles/client.conf 
sed -i -e "s~username~$username~g" /home/mtn/sampleFiles/login.conf
echo
printf '\e[1;34m%-6s\e[m\n' "Setting configuration files in place"
cp /home/mtn/sampleFiles/interfaces /etc/network/interfaces
cp /home/mtn/sampleFiles/client.conf /etc/openvpn/client.conf
cp /home/mtn/sampleFiles/login.conf /etc/openvpn/login.conf
cp /home/mtn/sampleFiles/interfacesTemplate /home/mtn/sampleFiles/interfaces
cp /home/mtn/sampleFiles/clientTemplate.conf /home/mtn/sampleFiles/client.conf
cp /home/mtn/sampleFiles/loginTemplate.conf /home/mtn/sampleFiles/login.conf
echo
printf '\e[1;34m%-6s\e[m\n' "Restarting Network services and openvpn services"
/etc/init.d/openvpn restart
systemctl restart networking.service
echo 
printf '\e[1;34m%-6s\e[m\n' "Please verify IPTABLES NAT rule on interface ens224 is set:  "
iptables -t nat -L POSTROUTING  -n -vvv
echo
printf '\e[1;34m%-6s\e[m\n' "if there was any error running the script , please start over entering 'obmconfiguration' in the shell prompt"
